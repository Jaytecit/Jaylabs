<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>JayLabs Playground</title>
    <link rel="icon" type="image/png" href="Images/Favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=Share+Tech+Mono&family=Orbitron:wght@500&display=swap');

        /* --- GLOBAL VARIABLES --- */
        :root {
            font-family: "Space Grotesk", system-ui, sans-serif;
            color-scheme: dark;
            --bg-deep: #030511;
            --accent-cyan: #00d9ff;
            --accent-purple: #9d00ff;
            --accent-magenta: #ff00ea;
            --text-1: #ffffff;
            --text-2: rgba(200, 220, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            /* Hi-Fi Unit Colors */
            --lcd-bg: #101215;
            --lcd-text: #00f0ff; 
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            background-color: var(--bg-deep);
            /* Retro Grid Background */
            background-image: 
                linear-gradient(rgba(0, 217, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 217, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-1);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
            width: 100%;
        }

        /* --- HERO SECTION (Logo + Hi-Fi) --- */
        .hero-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 1rem 3rem;
            position: relative;
            transition: opacity 0.3s ease; /* Smooth fade when hiding */
        }

        .logo-stage {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16 / 6; 
            margin-bottom: 3rem;
            filter: drop-shadow(0 0 30px rgba(0, 217, 255, 0.15));
        }

        .logo-element {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 1s ease;
        }

        .video-hidden { opacity: 0; pointer-events: none; }
        .img-hidden { opacity: 0; }
        .img-visible { opacity: 1; }

        /* --- JAYLABS JL-85 HI-FI UNIT STYLES --- */
        .hifi-unit {
            width: 100%;
            max-width: 960px;
            min-height: 280px;
            /* Brushed Aluminum Texture */
            background: 
                repeating-linear-gradient(90deg, rgba(0,0,0,0.02) 0px, rgba(0,0,0,0.02) 1px, transparent 1px, transparent 4px),
                linear-gradient(to bottom, #e0e0e0 0%, #f2f2f2 15%, #b0b0b0 100%);
            border-radius: 4px;
            position: relative;
            box-shadow: 
                0 0 0 1px #666, 
                0 20px 50px rgba(0,0,0,0.8),
                inset 0 1px 0 rgba(255,255,255,0.9);
            display: flex;
            flex-wrap: wrap; /* Allows stacking on mobile */
            padding: 30px;
            gap: 20px;
            margin-bottom: 2rem;
            color: #333;
        }

        /* Screws */
        .screw {
            width: 14px; height: 14px;
            background: radial-gradient(circle, #ddd, #999);
            border-radius: 50%; position: absolute;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.6), 1px 1px 1px rgba(255,255,255,0.5);
            border: 1px solid #777;
        }
        .screw::after { content: '+'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); color: #666; font-size: 16px; font-family: monospace; }
        .tl { top: 10px; left: 10px; } .tr { top: 10px; right: 10px; }
        .bl { bottom: 10px; left: 10px; } .br { bottom: 10px; right: 10px; }

        /* Panels */
        .hf-section { display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .hf-left { flex: 1.1; min-width: 250px; }
        .hf-center { flex: 1.2; min-width: 250px; align-items: center; padding: 0 10px; border-left: 1px solid rgba(0,0,0,0.1); border-right: 1px solid rgba(255,255,255,0.4); }
        .hf-right { flex: 1.1; min-width: 250px; border-left: 1px solid rgba(0,0,0,0.1); padding-left: 15px; }

        /* Mobile Adjustments for Hi-Fi */
        @media (max-width: 850px) {
            .hifi-unit { padding: 40px 20px; height: auto; gap: 30px; }
            .hf-center { border: none; padding: 20px 0; border-top: 1px solid rgba(0,0,0,0.1); border-bottom: 1px solid rgba(255,255,255,0.4); width: 100%; }
            .hf-right { border: none; padding: 0; width: 100%; }
        }

        /* Branding Text */
        .brand-logo {
            font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 900; color: #222;
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5); display: flex; align-items: center; gap: 8px;
        }
        .brand-logo span { color: #cc0000; }
        .model-no { font-family: sans-serif; font-size: 0.6rem; color: #555; letter-spacing: 1px; font-weight: bold; margin-top: -5px; margin-bottom: 10px;}

        /* LCD Screen */
        .lcd-frame {
            background: #222; padding: 2px; border-radius: 4px;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.5);
        }
        .lcd-window {
            background: var(--lcd-bg); border: 1px solid #333; border-radius: 2px;
            padding: 12px; position: relative; overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8); min-height: 100px;
        }
        .lcd-glass {
            position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.06) 0%, transparent 100%);
            pointer-events: none; z-index: 10;
        }
        .lcd-window::before { /* Scanlines */
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        /* Track Info Text */
        .track-info-display {
            height: 100%; font-family: 'Share Tech Mono', monospace; color: var(--lcd-text);
            text-shadow: 0 0 5px rgba(0, 240, 255, 0.5); display: flex; flex-direction: column; justify-content: space-between; position: relative; z-index: 1;
        }
        .row-top { display: flex; justify-content: space-between; font-size: 0.8rem; color: #008899; border-bottom: 1px solid #003333; padding-bottom: 2px;}
        .track-title { font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; text-shadow: 0 0 5px cyan; margin-top: 5px; }
        .track-artist { font-size: 0.9rem; color: rgba(0, 240, 255, 0.7); }
        .row-transport { display: flex; gap: 10px; font-size: 1rem; margin-top: auto; padding-top: 8px;}
        .icon-lit { color: #fff; text-shadow: 0 0 8px #fff; }
        .icon-dim { color: #003333; text-shadow: none; }

        /* Buttons */
        .button-row { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
        .silver-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid #999;
            background: radial-gradient(circle at 30% 30%, #fff, #ccc 60%, #999);
            box-shadow: 2px 4px 6px rgba(0,0,0,0.4); cursor: pointer; display: grid; place-items: center;
        }
        .silver-btn:active { transform: translateY(1px); background: #bbb; box-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        .silver-btn i { font-style: normal; font-size: 10px; font-weight: bold; color: #444; }

        /* Sliders (EQ & Volume) */
        .center-label {
            font-size: 0.6rem; color: #444; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            text-align: center; width: 100%; display: block; margin-bottom: 10px;
        }
        .eq-container {
            display: flex; gap: 8px; justify-content: center; padding: 10px;
            background: #222; border-radius: 4px;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.4);
        }
        input[type=range].eq-slider {
            -webkit-appearance: none; width: 6px; height: 100px;
            background: #000; border-radius: 4px; outline: none;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.8);
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
        }
        input[type=range].eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 10px;
            background: linear-gradient(to bottom, #555, #333); border: 1px solid #111;
            border-radius: 2px; cursor: ns-resize; box-shadow: 0 2px 4px rgba(0,0,0,0.8);
            position: relative; margin-left: -6px;
        }

        .vol-container { margin-top: 20px; width: 100%; padding: 0 10px;}
        input[type=range].vol-slider {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: #111; border-bottom: 1px solid #fff; outline: none;
        }
        input[type=range].vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 40px; height: 18px;
            background: linear-gradient(to bottom, #e6e6e6, #a1a1a1);
            border-radius: 2px; box-shadow: 1px 2px 4px rgba(0,0,0,0.5);
            cursor: pointer; border: 1px solid #666;
        }

        /* Spectrum Visualizer */
        .analyzer-wrapper {
            width: 100%; height: 100px; position: relative; display: flex; align-items: flex-end;
            background: linear-gradient(rgba(0,50,50,0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(0,50,50,0.2) 1px, transparent 1px);
            background-size: 10px 10px;
        }
        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }
        
        .meter-container { margin-top: 15px; display: flex; align-items: center; gap: 8px; }
        .meter-label { font-size: 0.6rem; font-weight: bold; color: #333; display: flex; flex-direction: column; line-height: 1.2; }
        .peak-bg {
            flex: 1; height: 10px; background: #111; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.8);
            border-radius: 2px; position: relative; overflow: hidden;
        }
        .peak-val {
            height: 100%; width: 0%;
            background: linear-gradient(to right, #00ff00 60%, #ffff00 85%, #ff0000 100%);
            box-shadow: 0 0 8px rgba(0,255,0,0.6); transition: width 0.1s;
        }
        .peak-bg::after {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(90deg, transparent 0, transparent 2px, #000 2px, #000 3px);
            opacity: 0.3;
        }

        /* --- NAVIGATION GRID --- */
        .nav-section { padding-bottom: 4rem; flex: 1; }
        
        .lab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--glass-border); border-radius: 16px; padding: 1.5rem;
            text-decoration: none; color: inherit; transition: transform 0.2s, background 0.2s, border-color 0.2s;
            position: relative; overflow: hidden; display: flex; flex-direction: column; min-height: 240px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card:hover {
            transform: translateY(-5px); background: rgba(255, 255, 255, 0.04);
            border-color: var(--accent-cyan); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .pill {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;
            padding: 0.25rem 0.75rem; border-radius: 100px; background: rgba(255,255,255,0.05);
            width: fit-content; margin-bottom: 0.75rem; border: 1px solid rgba(255,255,255,0.1);
        }

        .card h2 { margin: 0 0 0.5rem; font-size: 1.4rem; color: #fff; }
        .card p { font-size: 0.95rem; color: var(--text-2); margin: 0; line-height: 1.5; flex-grow: 1; }
        
        .card-link-text {
            margin-top: 1.5rem; color: var(--accent-cyan); font-weight: 600; font-size: 0.9rem;
            display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;
        }

        /* Specific Card Accents */
        .card.games:hover { border-color: var(--accent-magenta); }
        .card.games .card-link-text { color: var(--accent-magenta); }
        .card.pcvr:hover { border-color: var(--accent-cyan); }
        .card.gens:hover { border-color: var(--accent-purple); }
        .card.gens .card-link-text { color: var(--accent-purple); }

        /* Desktop Layout: Source card spans bottom */
        @media (min-width: 960px) {
            .lab-grid { grid-template-columns: repeat(3, 1fr); }
            .card.source {
                grid-column: 1 / -1; width: 70%; margin: 1rem auto 0;
                min-height: auto; flex-direction: row; align-items: center; gap: 2rem; padding: 1.2rem 2rem;
            }
            .card.source .card-content-wrapper { flex-grow: 1; display: flex; flex-direction: row; align-items: center; gap: 1.5rem; text-align: left; }
            .card.source .pill { margin-bottom: 0; }
            .card.source h2 { margin: 0; font-size: 1.2rem; min-width: 140px; }
            .card.source p { margin: 0; font-size: 0.9rem; }
            .card.source .card-link-text { margin-top: 0; }
        }

        /* --- FOOTER --- */
        footer {
            border-top: 1px solid rgba(255,255,255,0.1); padding: 2rem 1rem;
            text-align: center; color: var(--text-2); font-size: 0.85rem;
            background: rgba(0,0,0,0.3); margin-top: auto;
        }
        .footer-links { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; }
        footer a { color: var(--accent-cyan); text-decoration: none; transition: color 0.2s; }
        footer a:hover { color: #fff; text-decoration: underline; }
        
        @media (max-width: 600px) {
            .logo-stage { aspect-ratio: 16/9; }
            .footer-links { gap: 0.5rem; flex-direction: column; }
            .card.source { flex-direction: column; align-items: flex-start; }
            .card.source .card-content-wrapper { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        }
    </style>
</head>
<body>

    <!-- HERO SECTION: Logo & Hi-Fi Unit -->
    <section class="hero-section">
        
        <!-- Video Transition -->
        <div class="logo-stage">
            <video 
                id="logoVideo" 
                class="logo-element" 
                src="Images/Jaylabs.mp4" 
                muted playsinline autoplay
            ></video>
            <img 
                id="logoImage" 
                src="Images/Jaylabs.svg" 
                alt="JayLabs" 
                class="logo-element img-hidden"
            >
        </div>

        <!-- JAYLABS JL-85 HI-FI UNIT -->
        <div class="hifi-unit">
            <!-- Screws -->
            <div class="screw tl"></div><div class="screw tr"></div>
            <div class="screw bl"></div><div class="screw br"></div>

            <!-- LEFT: LCD & Transport -->
            <div class="hf-section hf-left">
                <div>
                    <div class="brand-logo">JAYLABS <span>AUDIO</span></div>
                    <div class="model-no">COMPACT DISC PLAYER JL-85</div>
                </div>
                
                <div class="lcd-frame">
                    <div class="lcd-window">
                        <div class="lcd-glass"></div>
                        <div class="track-info-display">
                            <div class="row-top">
                                <span id="trackIdx">TRACK 01</span>
                                <span id="timeDisplay">00:00</span>
                            </div>
                            <div class="track-title" id="trackTitle">INSERT DISC</div>
                            <div class="track-artist" id="trackArtist">JayLabs Audio</div>
                            <div class="row-transport">
                                <span id="icon-play" class="icon-dim">PLAY</span>
                                <span id="icon-pause" class="icon-dim">PAUSE</span>
                                <span style="margin-left:auto; font-size:0.8rem; color:#005555">STEREO</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button class="silver-btn" id="btnPrev" title="Previous"><i>|&lt;</i></button>
                    <button class="silver-btn" id="btnPlay" title="Play/Pause"><i>PLAY</i></button>
                    <button class="silver-btn" id="btnNext" title="Next"><i>&gt;|</i></button>
                </div>
            </div>

            <!-- CENTER: EQ & Volume -->
            <div class="hf-section hf-center">
                <span class="center-label">Graphic Equalizer</span>
                <div class="eq-container">
                    <!-- Fake Sliders -->
                    <input type="range" class="eq-slider" min="0" max="100" value="70">
                    <input type="range" class="eq-slider" min="0" max="100" value="60">
                    <input type="range" class="eq-slider" min="0" max="100" value="80">
                    <input type="range" class="eq-slider" min="0" max="100" value="50">
                    <input type="range" class="eq-slider" min="0" max="100" value="75">
                    <input type="range" class="eq-slider" min="0" max="100" value="85">
                    <input type="range" class="eq-slider" min="0" max="100" value="90">
                </div>
                <div class="vol-container">
                    <span class="center-label" style="text-align:left; margin-bottom:5px;">Master Volume</span>
                    <input type="range" id="volumeSlider" class="vol-slider" min="0" max="1" step="0.01" value="0.4">
                </div>
            </div>

            <!-- RIGHT: Real Visualizer -->
            <div class="hf-section hf-right">
                <div class="brand-logo" style="justify-content:flex-end; font-size:0.8rem;">SPECTRUM ANALYZER</div>
                <div class="model-no" style="text-align:right;">REAL TIME DISPLAY</div>

                <div class="lcd-frame">
                    <div class="lcd-window">
                        <div class="lcd-glass"></div>
                        <div class="analyzer-wrapper">
                            <canvas id="spectrumCanvas"></canvas>
                        </div>
                    </div>
                </div>

                <div class="meter-container">
                    <div class="meter-label"><span>L</span><span>R</span></div>
                    <div class="peak-bg">
                        <div class="peak-val" id="peakMeter"></div>
                    </div>
                    <div class="meter-label" style="margin-left:auto;"><span>0</span><span>dB</span></div>
                </div>
            </div>
        </div>
        <!-- END HI-FI UNIT -->

    </section>

    <!-- CONTENT: The Main Grid (ID required for turbo script) -->
    <div class="container nav-section" id="main-content">
        <div class="lab-grid">
            
            <a href="games.html" class="card games">
                <div class="pill">Arcade</div>
                <h2>Games</h2>
                <p>Aetherium League, Astral Core, and Defendorks. Action-packed cabinet smashers.</p>
                <div class="card-link-text">Launch Arcade &rarr;</div>
            </a>

            <a href="pcvr.html" class="card pcvr">
                <div class="pill">WebXR / VR</div>
                <h2>PCVR Lab</h2>
                <p>Experimental VR builds. Play directly in PCVR or via the Quest browser.</p>
                <div class="card-link-text">Enter VR Lab &rarr;</div>
            </a>

            <a href="generators.html" class="card gens">
                <div class="pill">Visuals</div>
                <h2>Generators</h2>
                <p>Harmonograph Studio & Spirograph Deluxe. Interactive math art tools.</p>
                <div class="card-link-text">Open Tools &rarr;</div>
            </a>

            <!-- Wide Source Card -->
            <a href="https://github.com/Jaytecit/Jaylabs" target="_blank" class="card source">
                <div class="card-content-wrapper">
                    <div class="pill">Collab</div>
                    <h2>Source Code</h2>
                    <p>View the repo, fork the projects, or contribute to the experiments.</p>
                </div>
                <div class="card-link-text">View GitHub &rarr;</div>
            </a>

        </div>
    </div>

    <footer>
        <div class="footer-links">
            <span>&copy; <span id="year"></span> JayLabs</span>
            <span>&nbsp;|&nbsp;</span>
            <a href="https://github.com/Jaytecit/Jaylabs" target="_blank" rel="noopener">GitHub</a>
            <span>&nbsp;|&nbsp;</span>
            <a href="mailto:Jay.Martooni@Jaylabs.co.uk">Contact Us</a>
            <span>&nbsp;|&nbsp;</span>
            <a href="legal.html">Legal</a>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script>
        // --- 1. Logo Video Transition ---
        const video = document.getElementById('logoVideo');
        const image = document.getElementById('logoImage');

        if(video) {
            video.addEventListener('ended', () => {
                video.classList.add('video-hidden');
                image.classList.remove('img-hidden');
                image.classList.add('img-visible');
            });
            video.addEventListener('error', () => {
                image.classList.remove('img-hidden');
                image.classList.add('img-visible');
            });
        }

        // --- 2. JAYLABS JL-85 AUDIO FIRMWARE ---
        
        // CONFIG: MATCH THESE TO YOUR ACTUAL FILENAMES
        const playlist = [
            { title: "Ambient Pad", artist: "JayLabs Audio", src: "Ambient.mp3" },
            { title: "Oxygen", artist: "JayLabs Audio", src: "Oxygen.mp3" },
            { title: "Electronic", artist: "JayLabs Audio", src: "Electronic.mp3" }
        ];

        let currentIndex = 0;
        let isPlaying = false;
        let audioCtx, analyser, source, dataArray, canvasCtx;
        
        const audio = new Audio();
        audio.crossOrigin = "anonymous"; 

        // DOM References
        const elTitle = document.getElementById('trackTitle');
        const elArtist = document.getElementById('trackArtist');
        const elTime = document.getElementById('timeDisplay');
        const elIdx = document.getElementById('trackIdx');
        const btnPlay = document.getElementById('btnPlay');
        const canvas = document.getElementById('spectrumCanvas');
        const peakMeter = document.getElementById('peakMeter');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');

        function initContext() {
            if(!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                analyser = audioCtx.createAnalyser();
                
                try {
                    source = audioCtx.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioCtx.destination);
                } catch (e) {
                    console.warn("Visualizer needs a local server (localhost) to work.", e);
                }
                
                analyser.fftSize = 64; 
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                canvasCtx = canvas.getContext('2d');
                draw();
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function loadTrack(i) {
            if (i < 0) i = playlist.length - 1;
            if (i >= playlist.length) i = 0;
            
            currentIndex = i;
            const track = playlist[currentIndex];
            
            audio.src = track.src;
            audio.load();
            
            elTitle.textContent = track.title;
            elArtist.textContent = track.artist;
            elIdx.textContent = `TRACK 0${currentIndex + 1}`;
            
            if(isPlaying) {
                audio.play().catch(e => console.log("Wait for interaction"));
            }
        }

        function togglePlay() {
            initContext();
            
            if(audio.paused) {
                audio.play()
                    .then(() => {
                        isPlaying = true;
                        iconPlay.className = "icon-lit";
                        iconPause.className = "icon-dim";
                    })
                    .catch(err => {
                        console.error(err);
                        elTitle.textContent = "FILE NOT FOUND";
                        elArtist.textContent = "Check Filename";
                    });
            } else {
                audio.pause();
                isPlaying = false;
                iconPlay.className = "icon-dim";
                iconPause.className = "icon-lit";
            }
        }

        function draw() {
            requestAnimationFrame(draw);
            const w = canvas.width = canvas.offsetWidth;
            const h = canvas.height = canvas.offsetHeight;
            canvasCtx.clearRect(0, 0, w, h);
            
            if(!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            
            const barWidth = (w / dataArray.length) * 2;
            let x = 0;
            let sum = 0;

            for(let i = 0; i < dataArray.length; i++) {
                const barH = (dataArray[i] / 255) * h;
                canvasCtx.fillStyle = `rgba(0, 240, 255, 0.8)`;
                canvasCtx.fillRect(x, h - barH, barWidth - 1, barH);
                x += barWidth;
                sum += dataArray[i];
            }
            
            const avg = sum / dataArray.length;
            const peak = Math.min(100, (avg / 255) * 300);
            if(peakMeter) peakMeter.style.width = `${peak}%`;
        }

        // Audio Events
        if(btnPlay) btnPlay.addEventListener('click', togglePlay);
        
        document.getElementById('btnNext')?.addEventListener('click', () => loadTrack(currentIndex + 1));
        document.getElementById('btnPrev')?.addEventListener('click', () => loadTrack(currentIndex - 1));
        
        document.getElementById('volumeSlider')?.addEventListener('input', (e) => {
            audio.volume = e.target.value;
        });

        audio.addEventListener('timeupdate', () => {
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            if(elTime) elTime.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        });

        audio.addEventListener('ended', () => loadTrack(currentIndex + 1));
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Load first track on init
        loadTrack(0);


        // --- 3. JAYLABS TURBO LOADER (Continuous Audio Nav) ---
        document.addEventListener('DOMContentLoaded', () => {
            const mainContent = document.getElementById('main-content');
            const heroSection = document.querySelector('.hero-section');
            
            // Snapshot the "Home" state
            const homeHTML = mainContent.innerHTML;
            const homeClasses = mainContent.className || "container nav-section";

            document.addEventListener('click', async (e) => {
                const link = e.target.closest('a');
                if (!link) return;

                const href = link.getAttribute('href');

                // Intercept internal .html links
                if (href && href.endsWith('.html') && !href.startsWith('http') && !href.startsWith('#') && link.target !== '_blank') {
                    e.preventDefault();

                    // === BACK TO HOME ===
                    if (href.includes('index.html')) {
                        if (heroSection) heroSection.style.display = 'flex';
                        mainContent.innerHTML = homeHTML;
                        mainContent.className = homeClasses;
                        window.history.pushState({page: 'home'}, '', 'index.html');
                        return;
                    }

                    // === LOAD SUB-PAGE ===
                    try {
                        const response = await fetch(href);
                        if (!response.ok) throw new Error('Page not found');
                        const html = await response.text();

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newContent = doc.querySelector('main');

                        if (newContent) {
                            if (heroSection) heroSection.style.display = 'none';
                            mainContent.innerHTML = newContent.innerHTML;
                            mainContent.className = newContent.className;
                            window.history.pushState({page: href}, '', href);
                            window.scrollTo(0, 0);
                        }
                    } catch (err) {
                        console.error("Nav Error:", err);
                        window.location.href = href; // Fallback
                    }
                }
            });

            // Browser Back Button
            window.addEventListener('popstate', (event) => {
                window.location.reload(); 
            });
        });
    </script>
</body>
</html>