<!DOCTYPE html>
<html>
  <head>
    <title>Cockpit & HUD Calibrator</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <script>
      AFRAME.registerComponent('calibrator', {
        init: function () {
          this.uiText = document.querySelector('#debug-text');
          this.leftHand = document.getElementById('leftHand');
          this.rightHand = document.getElementById('rightHand');
          this.cycleSelection = this.cycleSelection.bind(this);
          
          this.objects = [
            {
              id: 'cockpit',
              name: 'COCKPIT MODEL',
              el: document.querySelector('#target-cockpit'),
              pos: { x: -0.045, y: -2.993, z: -1.567 },
              rot: { x: 0, y: 180, z: 0 },
              scale: 1.479
            },
            {
              id: 'hudLeft',
              name: 'LEFT HUD (Vert Track)',
              el: document.querySelector('#target-hud-left'),
              pos: { x: -0.347, y: 0.522, z: -0.693 }, 
              rot: { x: -25, y: 10, z: 1 },
              scale: 0.08
            },
            {
              id: 'hudCenter',
              name: 'CENTER HUD (Tactical)',
              el: document.querySelector('#target-hud-center'),
              pos: { x: -0.045, y: 0.574, z: -0.671 },
              rot: { x: -15, y: 0, z: 0 },
              scale: 0.08
            },
            {
              id: 'hudRight',
              name: 'RIGHT HUD (Dist/Prox)',
              el: document.querySelector('#target-hud-right'),
              pos: { x: 0.258, y: 0.526, z: -0.689 },
              rot: { x: -25, y: -10, z: -1 },
              scale: 0.1
            }
          ];

          this.selectedIndex = 0;
          this.cooldown = 0;
          this.boundEvents = false;
          this.updateScene();
        },
        
        tick: function (time, timeDelta) {
          if (!this.leftHand || !this.rightHand) return;
          if (!this.boundEvents) {
            ['xbuttondown', 'ybuttondown', 'thumbstickdown'].forEach(evt => {
              this.leftHand.addEventListener(evt, this.cycleSelection);
            });
            ['abuttondown', 'bbuttondown', 'thumbstickdown'].forEach(evt => {
              this.rightHand.addEventListener(evt, this.cycleSelection);
            });
            this.boundEvents = true;
          }
          if (this.cooldown > 0) this.cooldown--;

          let currentObj = this.objects[this.selectedIndex];
          let leftCtrl = this.leftHand.components['tracked-controls'];
          let rightCtrl = this.rightHand.components['tracked-controls'];
          let leftAxis = leftCtrl?.axis || [0,0,0,0];
          let rightAxis = rightCtrl?.axis || [0,0,0,0];
          let leftBtns = leftCtrl?.buttons || [];
          let rightBtns = rightCtrl?.buttons || [];

          if (leftBtns[3] && leftBtns[3].pressed && this.cooldown <= 0) {
            this.selectedIndex = (this.selectedIndex + 1) % this.objects.length;
            this.cooldown = 20;
          }

          if (Math.abs(leftAxis[2]) > 0.1) currentObj.pos.x += leftAxis[2] * 0.005;
          if (Math.abs(leftAxis[3]) > 0.1) currentObj.pos.z += leftAxis[3] * 0.005;
          if (Math.abs(rightAxis[3]) > 0.1) currentObj.pos.y -= rightAxis[3] * 0.005;
          if (Math.abs(rightAxis[2]) > 0.1) {
            currentObj.scale += rightAxis[2] * 0.001;
            if(currentObj.scale < 0.001) currentObj.scale = 0.001;
          }

          if (leftBtns[0] && leftBtns[0].value > 0.5) currentObj.rot.x += 0.5;
          if (leftBtns[1] && leftBtns[1].pressed) currentObj.rot.x -= 0.5;
          if (rightBtns[0] && rightBtns[0].value > 0.5) currentObj.rot.y -= 0.5;
          if (rightBtns[1] && rightBtns[1].pressed) currentObj.rot.y += 0.5;

          if (rightBtns[1] && rightBtns[1].pressed && this.cooldown <= 0) {
            this.exportJSON();
            this.cooldown = 50;
          }

          this.updateScene();
          this.renderUI(currentObj);
        },

        updateScene: function() {
          this.objects.forEach(obj => {
            obj.el.object3D.position.set(obj.pos.x, obj.pos.y, obj.pos.z);
            obj.el.setAttribute('scale', `${obj.scale} ${obj.scale} ${obj.scale}`);
            obj.el.object3D.rotation.set(
              THREE.MathUtils.degToRad(obj.rot.x),
              THREE.MathUtils.degToRad(obj.rot.y),
              THREE.MathUtils.degToRad(obj.rot.z)
            );
          });
        },

        renderUI: function(obj) {
          this.uiText.setAttribute('value', 
            `>> ${obj.name} <<\n` +
            `------------------\n` +
            `POS: ${obj.pos.x.toFixed(3)}, ${obj.pos.y.toFixed(3)}, ${obj.pos.z.toFixed(3)}\n` +
            `ROT: ${obj.rot.x.toFixed(1)}, ${obj.rot.y.toFixed(1)}, ${obj.rot.z.toFixed(1)}\n` +
            `SCL: ${obj.scale.toFixed(4)}\n\n` +
            `[Buttons] Switch Object\n` +
            `[L Stick] X/Z | [R Stick] Y/Scale\n` +
            `[Triggers] Rotate`
          );
        },

        cycleSelection: function() {
          if (this.cooldown > 0) return;
          this.selectedIndex = (this.selectedIndex + 1) % this.objects.length;
          this.cooldown = 20;
        },

        exportJSON: function() {
          let output = {};
          this.objects.forEach(obj => {
            output[obj.id] = {
              position: `${obj.pos.x.toFixed(3)} ${obj.pos.y.toFixed(3)} ${obj.pos.z.toFixed(3)}`,
              rotation: `${obj.rot.x.toFixed(1)} ${obj.rot.y.toFixed(1)} ${obj.rot.z.toFixed(1)}`,
              scale: `${obj.scale.toFixed(3)} ${obj.scale.toFixed(3)} ${obj.scale.toFixed(3)}`
            };
          });
          
          let jsonStr = JSON.stringify(output, null, 2);
          let blob = new Blob([jsonStr], {type: "application/json"});
          let url = URL.createObjectURL(blob);
          let a = document.createElement('a');
          a.href = url;
          a.download = "calibrated_offsets.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      });
    </script>

    <a-scene background="color: #111" renderer="useLegacyLights: false">
      <a-assets>
        <a-asset-item id="cockpit-asset" src="cockpit.glb"></a-asset-item>
      </a-assets>

      <a-light type="ambient" color="#FFF"></a-light>
      <a-light type="directional" position="-1 1 0"></a-light>

      <a-entity id="calibrator-rig" calibrator>
        
        <a-text id="debug-text" 
                value="Waiting for controllers..." 
                position="0 1.5 -2" 
                align="center" 
                font="monoid"
                color="#00FF00"
                width="2.5"
                side="double"
                background="color: black"></a-text>

        <a-entity id="target-cockpit" gltf-model="#cockpit-asset"></a-entity>

        <a-text id="target-hud-left" 
                value="SHIELD: 100%\nV-TRACK: â–² UP" 
                font="sourcecodepro" 
                color="#00FF00" 
                align="center"
                width="4"></a-text>

        <a-text id="target-hud-center" 
                value="[ |||||||||| ]" 
                font="sourcecodepro" 
                color="#00AAFF" 
                align="center"
                width="3.5"></a-text>

        <a-text id="target-hud-right" 
                value="PROX: CLEAR\nDIST: 120m" 
                font="sourcecodepro" 
                color="#00FF00" 
                align="center"
                width="4"></a-text>

        <a-entity camera position="0 0 0" look-controls></a-entity>
        <a-entity id="leftHand" oculus-touch-controls="hand: left; model: true"></a-entity>
        <a-entity id="rightHand" oculus-touch-controls="hand: right; model: true"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>