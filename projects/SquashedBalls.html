<!DOCTYPE html>
<html>
  <head>
    <title>WebXR Paddle & Kinesis</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    
    <script>
      // ==========================================
      // COMPONENT: Kinesis / Grab Throw Logic
      // ==========================================
      AFRAME.registerComponent('kinesis-controller', {
        init: function () {
          this.heldObject = null;
          this.raycaster = this.el.components.raycaster;
          this.marker = document.querySelector('#aim-marker');
          
          this.lastPos = new THREE.Vector3();
          this.currentPos = new THREE.Vector3();
          this.velocity = new THREE.Vector3();

          this.onGripDown = this.onGripDown.bind(this);
          this.onGripUp = this.onGripUp.bind(this);
          
          this.el.addEventListener('gripdown', this.onGripDown);
          this.el.addEventListener('gripup', this.onGripUp);
        },

        tick: function (time, timeDelta) {
          // Calculate throw velocity
          this.el.object3D.getWorldPosition(this.currentPos);
          if (timeDelta > 0) {
            const frameVel = new THREE.Vector3().copy(this.currentPos).sub(this.lastPos).multiplyScalar(1000 / timeDelta);
            this.velocity.lerp(frameVel, 0.5); 
          }
          this.lastPos.copy(this.currentPos);

          if (!this.heldObject) {
            // Raycast Scanning
            const intersection = this.raycaster.getIntersection(document.querySelector('#the-ball'));
            if (intersection) {
              this.marker.setAttribute('visible', true);
              this.marker.setAttribute('position', intersection.point);
            } else {
              this.marker.setAttribute('visible', false);
            }
          } else {
            // Holding Logic
            this.marker.setAttribute('visible', false);
            const body = this.heldObject.body;
            const worldPos = new THREE.Vector3();
            const worldQuat = new THREE.Quaternion();
            
            this.el.object3D.getWorldPosition(worldPos);
            this.el.object3D.getWorldQuaternion(worldQuat);
            
            // Offset: Place ball slightly above and forward of the paddle tip
            // so it doesn't clip into the new vertical blade
            const offset = new THREE.Vector3(0, 0.2, -0.6); 
            offset.applyQuaternion(worldQuat);
            worldPos.add(offset);

            // Lock Physics
            body.position.set(worldPos.x, worldPos.y, worldPos.z);
            body.velocity.set(0, 0, 0);
            body.angularVelocity.set(0, 0, 0);
          }
        },

        onGripDown: function () {
          const intersection = this.raycaster.getIntersection(document.querySelector('#the-ball'));
          if (intersection) {
            this.heldObject = intersection.object.el;
            this.heldObject.setAttribute('material', 'emissive', '#FF0000');
            this.heldObject.setAttribute('material', 'emissiveIntensity', '0.5');
          }
        },

        onGripUp: function () {
          if (this.heldObject) {
            const body = this.heldObject.body;
            // Throw Force
            const throwVec = new THREE.Vector3().copy(this.velocity).multiplyScalar(1.5);
            body.velocity.set(throwVec.x, throwVec.y, throwVec.z);
            
            this.heldObject.setAttribute('material', 'emissive', '#000000');
            this.heldObject.setAttribute('material', 'emissiveIntensity', '0');
            this.heldObject = null;
          }
        }
      });

      // ==========================================
      // COMPONENT: Breakable Glass
      // ==========================================
      AFRAME.registerComponent('breakable', {
        schema: { threshold: { type: 'number', default: 3 } }, 
        init: function() {
          this.el.addEventListener('collide', (e) => {
            const relativeVelocity = e.detail.contact.getImpactVelocityAlongNormal();
            if(Math.abs(relativeVelocity) > this.data.threshold) {
              this.shatter();
            }
          });
        },
        shatter: function() {
          const sound = document.querySelector('#glass-sound');
          if(sound.components.sound) sound.components.sound.playSound();

          const parent = this.el.parentNode;
          const worldPos = new THREE.Vector3();
          this.el.object3D.getWorldPosition(worldPos);

          for(let i=0; i<6; i++) {
            const shard = document.createElement('a-entity');
            shard.setAttribute('geometry', { primitive: 'box', width: 1.5, height: 1.5, depth: 0.1 });
            shard.setAttribute('material', { color: 'cyan', opacity: 0.5, transparent: true });
            shard.setAttribute('position', {
              x: worldPos.x + (Math.random() - 0.5),
              y: worldPos.y + (Math.random() - 0.5),
              z: worldPos.z
            });
            shard.setAttribute('dynamic-body', {mass: 2});
            setTimeout(() => { if(shard.parentNode) shard.parentNode.removeChild(shard); }, 4000);
            parent.appendChild(shard);
          }

          this.el.setAttribute('visible', false);
          this.el.removeAttribute('static-body');
          this.el.setAttribute('position', '0 -50 0');
        }
      });

      // ==========================================
      // COMPONENT: UI Manager
      // ==========================================
      AFRAME.registerComponent('ui-manager', {
        init: function () {
          this.uiPanel = document.querySelector('#ui-panel');
          this.uiVisible = false;
          
          const toggleUI = () => {
            this.uiVisible = !this.uiVisible;
            this.uiPanel.setAttribute('visible', this.uiVisible);
            
            if(this.uiVisible) {
                const cam = document.querySelector('a-camera');
                const pos = cam.object3D.position.clone();
                const rot = cam.object3D.rotation.clone();
                const offset = new THREE.Vector3(0, 0, -1.5);
                offset.applyEuler(rot);
                pos.add(offset);
                this.uiPanel.setAttribute('position', pos);
                this.uiPanel.setAttribute('rotation', {x: 0, y: (rot.y * 180 / Math.PI), z: 0});
            }
          };

          this.el.addEventListener('xbuttondown', toggleUI);
          this.el.addEventListener('abuttondown', toggleUI);
          this.setupButtons();
        },

        setupButtons: function() {
          const ball = document.querySelector('#the-ball');
          const walls = document.querySelectorAll('.wall');
          const scene = document.querySelector('a-scene');
          const statusText = document.querySelector('#ui-status');
          const setStatus = (txt) => statusText.setAttribute('value', txt);
          const bind = (id, fn) => { document.querySelector(id).addEventListener('click', fn); };

          bind('#btn-bounce-high', () => { ball.body.material.restitution = 0.95; setStatus("Bounciness: SUPER"); });
          bind('#btn-bounce-low', () => { ball.body.material.restitution = 0.1; setStatus("Bounciness: DULL"); });
          bind('#btn-mass-heavy', () => { ball.body.mass = 50; ball.body.updateMassProperties(); ball.setAttribute('color', '#333'); setStatus("Ball: HEAVY IRON"); });
          bind('#btn-mass-light', () => { ball.body.mass = 1; ball.body.updateMassProperties(); ball.setAttribute('color', 'orange'); setStatus("Ball: TENNIS"); });
          bind('#btn-grav-moon', () => { scene.systems.physics.driver.world.gravity.set(0, -1.6, 0); setStatus("Gravity: MOON"); });
          bind('#btn-grav-earth', () => { scene.systems.physics.driver.world.gravity.set(0, -9.8, 0); setStatus("Gravity: EARTH"); });
          bind('#btn-reset', () => {
             ball.body.position.set(0, 1.5, -2);
             ball.body.velocity.set(0,0,0);
             ball.body.angularVelocity.set(0,0,0);
             walls.forEach(wall => {
                const orig = AFRAME.utils.coordinates.parse(wall.getAttribute('data-orig-pos'));
                wall.setAttribute('position', orig);
                wall.setAttribute('visible', true);
                if(!wall.components['static-body']) wall.setAttribute('static-body', '');
             });
             setStatus("SYSTEM RESET");
          });
        }
      });
    </script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8; restitution: 0.5">
      
      <a-assets>
         <audio id="glass-sound" src="https://cdn.freesound.org/previews/336/336898_4939227-lq.mp3" crossorigin="anonymous"></audio>
         <a-mixin id="btn-bg" geometry="primitive: box; width: 0.6; height: 0.15; depth: 0.02" material="color: #444"></a-mixin>
         <a-mixin id="btn-hover" animation__enter="property: material.color; to: #666; startEvents: mouseenter; dur: 200"
                                  animation__leave="property: material.color; to: #444; startEvents: mouseleave; dur: 200"></a-mixin>
      </a-assets>

      <a-entity environment="preset: tron; grid: none; lighting: point"></a-entity>

      <!-- The Physics Ball -->
      <a-sphere id="the-ball" position="0 1.5 -2" radius="0.15" color="orange"
                dynamic-body="mass: 1; linearDamping: 0.01" shadow></a-sphere>

      <!-- Aim Marker -->
      <a-sphere id="aim-marker" radius="0.05" color="#00ff00" visible="false" opacity="0.6" material="shader: flat"></a-sphere>

      <!-- Breakable Glass Room -->
      <a-entity id="room">
        <a-box class="wall" breakable position="0 3 -5" width="10" height="6" depth="0.2" color="cyan" opacity="0.3" transparent="true" static-body data-orig-pos="0 3 -5"></a-box>
        <a-box class="wall" breakable position="0 3 5" width="10" height="6" depth="0.2" color="cyan" opacity="0.3" transparent="true" static-body data-orig-pos="0 3 5"></a-box>
        <a-box class="wall" breakable position="-5 3 0" width="0.2" height="6" depth="10" color="cyan" opacity="0.3" transparent="true" static-body data-orig-pos="-5 3 0"></a-box>
        <a-box class="wall" breakable position="5 3 0" width="0.2" height="6" depth="10" color="cyan" opacity="0.3" transparent="true" static-body data-orig-pos="5 3 0"></a-box>
        <a-box class="wall" breakable position="0 6 0" width="10" height="0.2" depth="10" color="cyan" opacity="0.2" transparent="true" static-body data-orig-pos="0 6 0"></a-box>
      </a-entity>
      <a-plane static-body rotation="-90 0 0" width="100" height="100" visible="false"></a-plane>

      <!-- Player Rig -->
      <a-entity id="rig" ui-manager>
        <a-camera position="0 1.6 0" look-controls="pointerLockEnabled: false">
            <a-text value="Press X or A to Toggle Menu" position="0 -0.5 -1" align="center" width="1.5" color="#FFF" opacity="0.7"></a-text>
        </a-camera>

        <!-- LEFT HAND: UI Interaction Only -->
        <a-entity id="left-hand" laser-controls="hand: left" raycaster="objects: .clickable; far: 2"></a-entity>

        <!-- RIGHT HAND: Kinesis Controller + Vertical Paddle -->
        <a-entity id="right-hand" laser-controls="hand: right"
                  raycaster="objects: #the-ball; far: 20"
                  line="color: blue; opacity: 0.5"
                  kinesis-controller>
            
            <!-- Handle: Cylinder along Z (Forward) -->
            <a-cylinder radius="0.02" height="0.15" color="#333" 
                        rotation="90 0 0" position="0 0 -0.05"></a-cylinder>

            <!-- Paddle Blade: Vertical Box (Cricket Bat style) -->
            <!-- Width=0.02 (Thin edge), Height=0.25 (Vertical face), Depth=0.35 (Length along handle) -->
            <a-box width="0.02" height="0.25" depth="0.35" color="#d33"
                   position="0 0 -0.3"
                   shadow></a-box>

            <!-- Paddle Physics Collider (Invisible) -->
            <a-box width="0.02" height="0.25" depth="0.35"
                   position="0 0 -0.3"
                   visible="false"
                   static-body></a-box>
        </a-entity>
      </a-entity>

      <!-- UI PANEL (Hidden by default) -->
      <a-entity id="ui-panel" visible="false" position="0 1.5 -1.5">
         <a-plane width="1.8" height="2.2" color="#111" material="opacity: 0.95" shadow>
            <a-text value="LAB SETTINGS" align="center" position="0 0.9 0.01" width="5" color="#FFF"></a-text>
            <a-text id="ui-status" value="Ready" align="center" position="0 0.8 0.01" width="4" color="#4CC3D9"></a-text>
            <a-plane width="1.6" height="0.01" color="#555" position="0 0.7 0.01"></a-plane>

            <!-- BOUNCINESS -->
            <a-entity position="0 0.5 0">
                <a-text value="BOUNCINESS" align="center" position="0 0.12 0.01" width="3" color="#AAA"></a-text>
                <a-entity id="btn-bounce-low" class="clickable" mixin="btn-bg btn-hover" position="-0.4 0 0.02">
                    <a-text value="Low" align="center" z-offset="0.01" width="3"></a-text>
                </a-entity>
                <a-entity id="btn-bounce-high" class="clickable" mixin="btn-bg btn-hover" position="0.4 0 0.02">
                    <a-text value="High" align="center" z-offset="0.01" width="3"></a-text>
                </a-entity>
            </a-entity>

            <!-- MASS -->
            <a-entity position="0 0.1 0">
                <a-text value="BALL MASS" align="center" position="0 0.12 0.01" width="3" color="#AAA"></a-text>
                <a-entity id="btn-mass-light" class="clickable" mixin="btn-bg btn-hover" position="-0.4 0 0.02">
                    <a-text value="Light" align="center" z-offset="0.01" width="3"></a-text>
                </a-entity>
                <a-entity id="btn-mass-heavy" class="clickable" mixin="btn-bg btn-hover" position="0.4 0 0.02">
                    <a-text value="Heavy" align="center" z-offset="0.01" width="3"></a-text>
                </a-entity>
            </a-entity>

            <!-- GRAVITY -->
            <a-entity position="0 -0.3 0">
                <a-text value="GRAVITY" align="center" position="0 0.12 0.01" width="3" color="#AAA"></a-text>
                <a-entity id="btn-grav-earth" class="clickable" mixin="btn-bg btn-hover" position="-0.4 0 0.02">
                    <a-text value="Earth" align="center" z-offset="0.01" width="3"></a-text>
                </a-entity>
                <a-entity id="btn-grav-moon" class="clickable" mixin="btn-bg btn-hover" position="0.4 0 0.02">
                    <a-text value="Moon" align="center" z-offset="0.01" width="3"></a-text>
                </a-entity>
            </a-entity>

            <a-plane width="1.6" height="0.01" color="#555" position="0 -0.55 0.01"></a-plane>

            <!-- RESET -->
            <a-entity id="btn-reset" class="clickable" position="0 -0.75 0.02" 
                      geometry="primitive: box; width: 1.4; height: 0.25; depth: 0.02" 
                      material="color: #c00"
                      animation__enter="property: scale; to: 1.05 1.05 1; startEvents: mouseenter; dur: 150"
                      animation__leave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 150">
                <a-text value="RESET SIMULATION" align="center" width="4" z-offset="0.02" color="white" font="exo2bold"></a-text>
            </a-entity>
         </a-plane>
      </a-entity>

    </a-scene>
  </body>
</html>